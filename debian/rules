#!/usr/bin/make -f
#export DH_VERBOSE=1

%:
	dh $@ --with autotools_dev

override_dh_auto_configure:
	(cd jasper-1.900.1-6ct && autoreconf -i --force)
	dh_auto_configure --sourcedirectory=jasper-1.900.1-6ct -- --disable-libjpeg
	dh_auto_configure --sourcedirectory=jpeg-6c

jasper-1.900.1-6ct/src/libjasper/.libs/libjasper.a:
	$(MAKE) -C jasper-1.900.1-6ct

jpeg-6c/libjpeg.a:
	$(MAKE) -C jpeg-6c

dgate: jpeg-6c/libjpeg.a jasper-1.900.1-6ct/src/libjasper/.libs/libjasper.a
	g++ $(CPPFLAGS) $(CXXFLAGS) -Ijasper-1.900.1-6ct/src/libjasper/include -Ijpeg-6c -I/usr/include/lua5.1 -DUNIX -DNATIVE_ENDIAN=1 -DHAVE_LIBJASPER -DHAVE_LIBJPEG -DUSESQLITE -Wno-write-strings total.cpp -o dgate -lpthread -llua5.1 -lsqlite3 jpeg-6c/libjpeg.a jasper-1.900.1-6ct/src/libjasper/.libs/libjasper.a -Wno-multichar $(LDFLAGS)

override_dh_auto_build: dgate
	#cp dicom.ini dicom.ini.bak
	cp dicom.ini.sqlite dicom.ini
	cp dicom.sql.sqlite dicom.sql

override_dh_install:
	# DICOM Server:
	dh_install dgate       usr/lib/conquest-dicom-server/
	dh_install dgate.dic   usr/lib/conquest-dicom-server/
	dh_install dicom.sql   usr/lib/conquest-dicom-server/
	dh_install dicom.ini   usr/lib/conquest-dicom-server/
	dh_install sample.cq   usr/lib/conquest-dicom-server/
	dh_install acrnema.map usr/lib/conquest-dicom-server/
	# web
	#dh_install conquest.jpg /var/www
	dh_install debian/dgate.conf etc/apache2/mods-available
	dh_install debian/dgate.load etc/apache2/mods-available

override_dh_auto_clean:
	dh_auto_clean --sourcedirectory=jasper-1.900.1-6ct
	dh_auto_clean --sourcedirectory=jpeg-6c

override_dh_clean:
	dh_clean dicom.ini
	dh_clean dicom.sql
	#mv dicom.ini.bak dicom.ini
	-rm dgate

get-orig-source:
	./debian/get-orig-source
